{% extends 'base.html' %}
{% load static %}

{% block head %}
<title>Menu: Venta telefónica</title>
{% endblock head %}

{% block content %}
    {% if platillos %}
    <form id="formMenu" method="POST">
        <!-- definimos las pestañas (vía una lista no ordenada) -->
        <ul class="nav nav-tabs nav-fill p-3" id="paneles" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="menu-tab" data-mdb-toggle="tab" href="#panel-menu" role="tab" aria-controls="panel-menu" aria-selected="true">Menús completos</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="ordenes-tab" data-mdb-toggle="tab" href="#panel-ordenes" role="tab" aria-controls="panel-ordenes" aria-selected="false">Órdenes</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="extras-tab" data-mdb-toggle="tab" href="#panel-extras" role="tab" aria-controls="panel-extras" aria-selected="false">Extras</a>
            </li>
        </ul>

        <!-- Definimos los elementos de la tabla como divisiónes de la clase "tab-pane" -->
        <div class="tab-content p-3" id="contenido-paneles">

            <!-- panel 1: menús -->
            <div class="tab-pane fade show active" id="panel-menu" role="tabpanel" aria-labelledby="menu-tab">
                <div class="d-flex flex-column px-3" id="contenedor-lista">
                    <ul class="list-group flex-fill" id="lista-menus">
                        <!--este elemento estará oculto, pero se usará de referencia para generar las entradas de la lista de menús completos-->
                        <li class="list-group-item" id="plantilla-menu" hidden>
                            <div class="d-flex align-items-center justify-content-between flex-wrap" id="contenedor-entrada-lista">
                                <div class="numero-menu">
                                    menú número
                                </div>
                                <div class="dropdown">
                                    <button class="btn dropdown-toggle btn-warning" type="button" data-mdb-toggle="dropdown">Entrada</button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                        {% for entrada in entradas %}
                                        <li><button type="button" class="dropdown-item" onclick="seleccionar(this)">{{ entrada }}</button></li>
                                        {% endfor %}
                                        <!-- acá se va a guardar la selección de platillo -->
                                        <div id="seleccion-entrada" class="seleccion" hidden></div>
                                    </ul>
                                </div>
                                <div class="dropdown">
                                    <button class="btn dropdown-toggle btn-warning" type="button" data-mdb-toggle="dropdown">Segúndo tiempo</button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                        {% for segundo_tiempo in segundos_tiempos %}
                                        <li><button type="button" class="dropdown-item" onclick="seleccionar(this)">{{ segundo_tiempo }}</button></li>
                                        {% endfor %}
                                        <!-- acá se va a guardar la selección de platillo -->
                                        <div id="seleccion-segundo-tiempo" class="seleccion" hidden></div>
                                    </ul>
                                </div>
                                <div class="dropdown">
                                    <button class="btn dropdown-toggle btn-warning" type="button" data-mdb-toggle="dropdown">Güisado</button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                        {% for guisado in guisados %}
                                        <li><button type="button" class="dropdown-item" onclick="seleccionar(this)">{{ guisado }}</button></li>
                                        {% endfor %}
                                        <!-- acá se va a guardar la selección de platillo -->
                                        <div id="seleccion-guisado" class="seleccion" hidden></div>
                                    </ul>
                                </div>
                                <button type="button" class="btn btn-primary btn-danger" onclick="removerMenu(this)">
                                    <i class="far fa-trash-alt fa-lg"></i>
                                </button>
                            </div>
                        </li>
                    </ul>
                    <!-- Botón para agregar un nuevo menú completo -->
                    <div class="d-flex justify-content-end py-3">
                        <button type="button" class="btn btn-primary btn-md btn-warning" onclick="agregarMenu()">
                            <i class="fas fa-plus fa-lg">&Tab;agregar otro menú</i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- panel 2: órdenes  -->
            <div class="tab-pane fade" id="panel-ordenes" role="tabpanel" aria-labelledby="ordenes-tab">
                <table class="table">
                    <thead>
                    <tr>
                        <th scope="col">Platillo</th>
                        <th scope="col">Costo</th>
                        <th scope="col"></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for platillo in platillos%}
                        <tr>
                            {% for nombre, precio in platillo %}
                                <td>{{ nombre }}</td>
                                <td class="precio">{{ precio }}</td>
                            {% endfor %}
                            {% csrf_token %}
                            <td><div class="d-flex justify-content-start">
                                <div class="form-outline">
                                    <input readonly value="0" type="text" id="{{ platillo }}" class="form-control" name="{{ platillo }}"/>
                                    <label class="form-label" for="form1">Cantidad</label>
                                </div>
                                <div class="btn-group-vertical d-inline btn-group-sm" role="group" aria-label="Vertical button group">
                                    <button type="button" class="btn btn-outline-warning" data-mdb-ripple-color="dark" onclick="incrementaSpinner({{ platillo }})">
                                    <i class="fas fa-angle-up"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-warning" data-mdb-ripple-color="dark" onclick="decrementaSpinner({{ platillo }})">
                                    <i class="fas fa-angle-down"></i>
                                    </button>
                                </div>
                            </div></td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- panel 3: extras -->
            <div class="tab-pane fade" id="panel-extras" role="tabpanel" aria-labelledby="extras-tab">
                aca van los extras. pero aun no tan :)
            </div>

        </div>

        <div class="card">
            <div class="card-body">
                <div class="form-outline">
                    <textarea class="form-control" id="textAreaExample" rows="4" name="observaciones"></textarea>
                    <label class="form-label" for="textAreaExample">Observaciones del pedido</label>
                </div>
                <div class="row g-0 gy-0 mt-2">
                    <div class="col">
                        <div class="d-grid gap-2 p-1">
                            <a href="{{ referer }}" class="btn btn-warning">
                                <i class="fas fa-arrow-left"></i>
                                Regresar
                            </a>
                        </div>
                    </div>
                    <div class="col">
                        <div class="d-grid gap-2 p-1">
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-cart-plus"></i>
                                Añadir al carrito
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    {% else %}
    <div class="container">
        <div class="row">
          <div class="col-md">
            <div class="card">
                <div class="card-body">
                  <p class="card-text">
                    ¡No hay platillos registrados en la base de datos!
                  </p>
                  <div class="row">
                      <div class="col-md">
                        <div class="card shadow-0 mb-3">
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <a href="{{ referer }}" class="btn btn-warning">
                                        <i class="fas fa-arrow-left"></i>
                                        Regresar
                                    </a>
                                </div>
                            </div>
                        </div>
                      </div>
                  </div>
                </div>
              </div>
          </div>
        </div>
    </div>
    {% endif %}

{% endblock content %}

{% block script %}
        <script>
        var numero_menus = 0

        function agregarMenu(){
            //creamos un elemeno de tipo ítem de lista (<li>),
            //le asignamos las clases list-group-item y menu-completo,
            //y le damos un identificador del siguente lugar en la lista
            var nuevoMenu = document.createElement("li")
            nuevoMenu.className = "list-group-item menu-completo"
            nuevoMenu.id = "menu-" + numero_menus

            //buscamos en el documento el elemento con id "plantilla-menu", extraemos su código HTML,
            //y se lo insertamos al menú que acabamos de crear,
            //para luego buscar el elemento "lista-menus" y agregrle el menú que acabamos de crear.
            //luego buscamos dentro del elemento buscamos el texto y le ponemos su número de menú
            //por último incrementamos el contador de cuantos menús hay en la vista
            nuevoMenu.innerHTML = document.getElementById("plantilla-menu").innerHTML
            nuevoMenu.getElementsByClassName("numero-menu")[0].innerText = "Menú " + (numero_menus + 1)
            document.getElementById("lista-menus").appendChild(nuevoMenu)
            numero_menus++
        }

        //agregamos la primera órden
        agregarMenu()

        function removerMenu(boton){
            //ya que el botón se pasa a si mismo como parámetro, lo usamos de referencia para obtener su contenedor,
            //en este caso su "abuelo" (padre del padre).
            //ya que tenemos ese elemento, lo borramos,
            //y decrementamos el contador de menús en la vista
            menu = boton.parentElement.parentElement
            menu.remove()
            numero_menus--

            //ahora obtenemos todos los menús en el documento,
            //y a cada uno le reasignamos su ID y texto para mantener la secuencia de estos
            menus = document.getElementsByClassName("menu-completo")
            for (var i=0; i<menus.length; i++){
                menus[i].id = "menu-" + i
                menus[i].getElementsByClassName("numero-menu")[0].innerText = "Menú " + (i + 1)
            }
        }

        //función para marcar que selección se hizo en los menús completos
        function seleccionar(boton){
            seleccion = boton.parentElement.parentElement.getElementsByClassName("seleccion")[0]
            boton_dropdown = boton.parentElement.parentElement.parentElement.getElementsByClassName("btn")[0]

            seleccion.innerText = boton.innerText
            boton_dropdown.innerText = boton.innerText
        }

        function incrementaSpinner(platillo){
            console.log(String(platillo));
            var id = "['"+String(platillo[0])+"', "+String(platillo[1]+"]");//dar formato al arreglo que recibe como parámetro para concordar con el id del elemento
            var val = document.getElementById(id).value;//obtenemos el valor del elemento
            val = parseInt(val) + 1;//lo parseamos a int e incrementamos en 1
            if(!isNaN(val)){//validación Is Not a Number
                if(val<100)
                    document.getElementById(id).value = val;//actualizamos el valor
            }
        }

        function decrementaSpinner(platillo){
            var id = "['"+String(platillo[0])+"', "+String(platillo[1]+"]");
            var val = document.getElementById(id).value;
            val = parseInt(val) - 1;
            if(!isNaN(val)){
                if(val>=0)
                    document.getElementById(id).value = val;
            }
        }

        //objeto de tipo internacionalización para formatear cifras a precios
        const formato = new Intl.NumberFormat('es-MX',{
            style: 'currency',
            currency: 'MXN',
            minimumFractionDigits: 2
        })

        //formateamos los objetos de la clase "precio" en formato monetario
        precios =  document.getElementsByClassName("precio")
        for(var i=0; i<precios.length; i++){
            precios[i].innerHTML = formato.format(precios[i].innerHTML)
        }
    </script>
{% endblock script %}